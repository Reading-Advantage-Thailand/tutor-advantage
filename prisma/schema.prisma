generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?
  createdAt         DateTime @default(now()) @map(name: "created_at")
  updatedAt         DateTime @default(now()) @map(name: "updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map(name: "accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map(name: "sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now()) @map(name: "created_at")
  updatedAt     DateTime  @default(now()) @map(name: "updated_at")

  accounts Account[]
  sessions Session[]

  isOnboardingCompleted Boolean @default(false) @map(name: "is_onboarding_completed")

  stripeCustomerId       String?   @unique @map(name: "stripe_customer_id")
  stripeSubscriptionId   String?   @unique @map(name: "stripe_subscription_id")
  stripePriceId          String?   @map(name: "stripe_price_id")
  stripeCurrentPeriodEnd DateTime? @map(name: "stripe_current_period_end")

  tutor   Tutor?
  student Student?
  role    Role?

  @@map(name: "users")
}

enum Role {
  TUTOR
  STUDENT
  ADMIN
}

enum EnrollmentStatus {
  PENDING
  ACTIVE
  COMPLETED
  EXPIRED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

model Tutor {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  inviteCode String   @unique
  invitedBy  String?
  inviter    Tutor?   @relation("TutorInvites", fields: [invitedBy], references: [id])
  invitees   Tutor[]  @relation("TutorInvites")
  classes    Class[]
  createdAt  DateTime @default(now()) @map(name: "created_at")
  updatedAt  DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "tutors")
}

model Student {
  id          String            @id @default(cuid())
  userId      String            @unique
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments Enrollment[]
  sessions    TutoringSession[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@map(name: "students")
}

model Class {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text
  icon        String
  subject     String? // Math, Science, English, etc.
  level       String? // Beginner, Intermediate, Advanced
  tutorId     String
  tutor       Tutor   @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  inviteCode  String  @unique
  isActive    Boolean @default(true)

  // Pricing and hours configuration
  pricePerHour Float  @default(0)
  packagePrice Float? // Optional package pricing
  defaultHours Float  @default(16) // Default hours in a package
  maxStudents  Int? // Optional capacity limit

  enrollments Enrollment[]
  sessions    TutoringSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map(name: "classes")
}

model Enrollment {
  id        String @id @default(cuid())
  classId   String
  studentId String

  // Payment tracking
  stripePaymentIntentId String?
  amount                Float
  paymentStatus         PaymentStatus @default(PENDING)

  // Hours tracking
  totalHours     Float
  hoursUsed      Float @default(0)
  hoursRemaining Float @default(0) // Computed field helper

  // Status and lifecycle
  status      EnrollmentStatus @default(PENDING)
  enrolledAt  DateTime? // When payment was confirmed
  completedAt DateTime? // When all hours are used
  expiresAt   DateTime? // Optional expiration date

  // Auto-renewal settings
  autoRenew       Boolean @default(false)
  renewalNotified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  class    Class             @relation(fields: [classId], references: [id], onDelete: Cascade)
  student  Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  sessions TutoringSession[]
  Payment  Payment[]

  @@unique([classId, studentId]) // One active enrollment per student per class
  @@map(name: "enrollments")
}

// Track individual tutoring sessions for hour usage
model TutoringSession {
  id           String @id @default(cuid())
  enrollmentId String
  classId      String
  studentId    String

  // Session details
  duration    Float // Hours used in this session
  scheduledAt DateTime? // When session was scheduled
  startedAt   DateTime? // When session actually started
  endedAt     DateTime? // When session ended

  // Session content
  topic    String?
  notes    String? @db.Text
  homework String? @db.Text

  // Status
  status SessionStatus @default(SCHEDULED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  class      Class      @relation(fields: [classId], references: [id], onDelete: Cascade)
  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map(name: "tutoring_sessions")
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// Track payment history for transparency
model Payment {
  id                    String        @id @default(cuid())
  enrollmentId          String
  stripePaymentIntentId String        @unique
  amount                Float
  currency              String        @default("usd")
  status                PaymentStatus
  stripeStatus          String? // Raw Stripe status

  // Metadata
  description String?
  receiptUrl  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@map(name: "payments")
}

// Store Stripe webhook events for debugging
model StripeEvent {
  id            String   @id @default(cuid())
  stripeEventId String   @unique
  type          String
  processed     Boolean  @default(false)
  data          Json
  createdAt     DateTime @default(now())

  @@map(name: "stripe_events")
}
